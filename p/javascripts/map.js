scene.map.FloorLoader=subclass(scene.common.Scene,function(t){"use strict";t.constructor=function(){this.charPosRepo=new datadomain.CharPositionRepository,this.floorRepo=new datadomain.FloorRepository,this.chr=new domain.common.Ma},t.start=function(){var t=this;this.charPosRepo.getCharPosition(this.chr.name).then(function(o){return t.floorRepo.getById(o.floorId)}).then(function(o){t.floor=o,t.finish()})}}),scene.map.MapScene=subclass(scene.common.Scene,function(t){"use strict";t.constructor=function(t){this.floor=new domain.map.Floor,this.wall=new domain.map.Wall,this.wall.loadFromObjectList(t.floor.objects.objects),this.chr=t.chr,this.chr.setParent(this.wall.$dom),this.cls=new domain.map.CharLocateService(this.wall,this.chr),this.wall.setCharLocateService(this.cls),this.menuButton=$(".menu-button").menuButton($("#map-menu")),this.lifeButton={}},t.start=function(){var t=this;return t.menuButton.show(),ui.common.BackgroundService.turnWhite().then(function(){return t.floor.appear()}).then(function(){return t.wall.appear()}).then(function(){return t.cls.charAppear()})},t.fadeOut=function(){this.menuButton.hide();var t=this;return this.wall.disappear().then(function(){return t.floor.disappear()}).then(function(){return ui.common.BackgroundService.turnBlack()})},t.goToLevel=function(t){var o=this;return this.cls.getIntoDoor().then(function(){return o.fadeOut()}).then(function(){location.href="level.html#"+t})},t.reload=function(){var t=this;return this.cls.getIntoDoor().then(function(){return t.fadeOut()}).then(function(){location.reload()})}}),domain.map.WallObject=subclass(function(t){"use strict";t.setParent=function(t){return this.parent=t,this},t.setPos=function(t){return this.x=t.x,this.y=t.y,this},t.rightLimit=function(){return this.x+this.w},t.centerX=function(){return this.x+this.w/2},t.centerY=function(){return this.y+this.h},t.setSize=function(t){return this.w=t.width,this.h=t.height,this},t.setCharLocateService=function(t){return this.cls=t,this},t.createDom=function(){return $("<div />").css({backgroundColor:"black",opcaity:0})},t.appear=function(){return this.$dom=this.$dom||this.createDom().width(this.w).height(this.h).offset({left:this.x,top:this.y}).appendTo(this.parent),this.$dom.anim(this.appearAnim,this.appearDur)},t.disappear=function(){var t=this;return this.$dom.anim(this.disappearAnim,this.disappearDur).then(function(){t.$dom.remove()})},t.open=function(){return Promise.resolve()},t.close=function(){return Promise.resolve()}}),domain.map.CharLocateService=function(){"use strict";var t=function(t,o){this.wall=t,this.chr=o,this.charPosRepo=new datadomain.CharPositionRepository},o=t.prototype;return o.charAppear=function(){var t=this.wall.findById(this.position.floorObjectId);this.current=t;var o=this.chr,i=t.centerX(),n=t.centerY();return o.x=i,o.y=n,t.open().then(function(){o.appear()})},o.moveToWallObjectByName=function(t){return this.moveToWallObject(this.wall.findById(t))},o.moveToWallObject=function(t){var o=this,i=this.wall.findById(this.position.floorObjectId);this.position.floorObjectId=t.id,this.charPosRepo.setCharPosition(this.chr.name,this.position);var n=400,e=1e3,r=400,s=80;return this.wall.visible(this.chr)||this.wall.scrollSet(i.centerX()),i.close(),this.chr.moveTo("y",this.wall.groundLevel+s,n).then(function(){return o.wall.scrollTo(t.centerX(),e),t.open(),o.chr.moveTo("x",t.centerX(),e)}).then(function(){return o.chr.moveTo("y",t.centerY(),r)}).then(function(){return o.current=t,o.chr.turn("down")})},o.getIntoDoor=function(){var t=this;return this.chr.turn("up"),this.chr.disappear().then(function(){return t.current.close()})},o.load=function(){var t=this;return this.charPosRepo.getCharPosition(this.chr.name).then(function(o){return t.position=o,t})},o.setCharPosition=function(t){return this.charPosRepo.setCharPosition(this.chr.name,t)},t}(),domain.map.Door=subclass(domain.map.WallObject,function(t){"use strict";var o=400;t.constructor=function(t,o,i,n){this.id=t,this.level=o,this.star=i,this.score=n},t.constructor.createFromObject=function(o){return new t.constructor(o.id,o.level,o.star,o.score).setPos(o.offset).setSize(o.size)},t.createDom=function(){var t=this;return this.$doorFrame=$("<div />").addClass("door-frame").css("opcaity",0),this.$door=$("<div />").addClass("door").appendTo(this.$doorFrame),this.$door.click(function(){t.cls.moveToWallObjectByName(t.id)}),$("<div />").addClass("door-front").text(this.id).appendTo(this.$door),$("<div />").addClass("doorknob").text("\u25cf").appendTo(this.$door),this.infoPane=$('<div><div class="door-info-content"><p>'+this.id+"</p><hr /><p><small>\u265b Best \u265b</small><br />"+this.score+"</p><hr /></div></div>").addClass("door-info").css({width:"150px",height:"150px",top:"-200px",left:"-40px"}).appendTo(this.$doorFrame).infoPane(3,5,{bgcolor:"#393F44"}),$("<button />").text("\u25b6").appendTo($(".door-info-content",this.infoPane.$dom)).click(function(o){o.preventDefault(),window.ms.goToLevel(t.level)}),this.$doorFrame},t.open=function(){return this.infoPane.show(),this.$door.addClass("open"),wait(this.doorActionDur)},t.close=function(){return this.infoPane.hide(),this.$door.removeClass("open"),wait(this.doorActionDur)},t.doorActionDur=400,t.appearAnim="door-appear",t.appearDur=o,t.disappearAnim="door-disappear",t.disappearDur=o}),domain.map.Floor=function(t){"use strict";var o=400,i=function(){this.$dom=t(".floor")};i.HEIGHT_RATE=.35;var n=i.prototype;return n.appear=function(){return this.$dom.removeClass("floor-hidden"),this.$dom.anim("floor-appear",o)},n.disappear=function(){var t=this;return t.$dom.addClass("floor-hidden"),this.$dom.anim("floor-disappear",o).then(function(){})},i}(window.jQuery),domain.map.Staircase=subclass(domain.map.WallObject,function(t){"use strict";t.constructor=function(t,o,i){this.id=t,this.to=o,this.type=i},t.constructor.createFromObject=function(o){var i=new datadomain.CharPositionFactory;return new t.constructor(o.id,i.createFromObject(o.opts.to),o.opts.type).setPos(o.offset).setSize(o.size)},t.createDom=function(){var t=this;return this.$dom=$("<div />").addClass("staircase staircase-"+this.type),this.$dom.on("click touchstart",function(){t.cls.moveToWallObjectByName(t.id).then(function(){return t.cls.setCharPosition(t.to)}).then(function(){return window.ms.reload()})}),this.$dom}}),domain.map.Wall=function(t){"use strict";var o=function(){this.wos=[],this.groundLevel=t(window).height()*(1-domain.map.Floor.HEIGHT_RATE),this.wallWidth=t(window).width(),this.$dom=t(".floor-wrapper")},i=o.prototype;return i.loadFromObjectList=function(t){var o=this;this.wos=t.map(function(t){return o.transformCoordinates(t),domain.map.WallObjectFactory.createFromObject(t).setParent(o.$dom)}),this.expandRightLimit(100)},i.transformCoordinates=function(t){t.offset.y*=-1,t.offset.y+=this.groundLevel,t.offset.y-=t.size.height},i.expandRightLimit=function(o){var i=this.rightLimit()+o;t("<div />").appendTo(this.$dom).css({width:"1px",height:"1px",position:"absolute"}).offset({left:i,top:this.groundLevel})},i.rightLimit=function(){return Math.max.apply(Math,this.wos.map(function(t){return t.rightLimit()}))},i.appear=function(){var t=this,o=this.cls.load().then(function(o){t.scrollSetToPosition(o.position.floorObjectId)});return this.wos.forEach(function(t){o=o.then(function(){return t.appear(),wait(100)})}),o},i.disappear=function(){var t=Promise.resolve();return this.wos.forEach(function(o){t=t.then(function(){return o.disappear(),wait(100)})}),t},i.scrollSetToPosition=function(t){var o=this.findById(t);return null==o?void console.error("wall object not found (id = "+t+")"):this.scrollSet(o.centerX())},i.scrollSet=function(t){return this.$dom.scrollLeft(t-this.wallWidth/2),this},i.scroll=function(t,o){return this.$dom.animate({scrollLeft:this.$dom.scrollLeft()+t},o),wait(o)},i.scrollTo=function(t,o){return this.$dom.animate({scrollLeft:t-this.wallWidth/2},o),wait(o)},i.setCharLocateService=function(t){return this.cls=t,this.wos.forEach(function(o){o.setCharLocateService(t)}),this},i.visible=function(t){return t.rightLimit()>this.$dom.scrollLeft()&&t.leftLimit()<this.$dom.scrollLeft()+this.wallWidth},i.findById=function(t){return this.wos.filter(function(o){return o.id===t})[0]},o}(window.jQuery),domain.map.WallObjectFactory=function(){"use strict";var t=function(){};return t.createFromObject=function(t){switch(t.type){case"l":return new domain.map.Door.createFromObject(t);case"s":return new domain.map.Staircase.createFromObject(t);case"e":return new domain.map.Elevator.createFromObject(t)}},t}();